package com.foru.blog.strategy.impl;import com.alibaba.fastjson.JSON;import com.alibaba.fastjson.JSONObject;import com.foru.blog.config.properties.GitHubProperties;import com.foru.blog.constant.SocialLoginConst;import com.foru.blog.dto.blog.SocialTokenDTO;import com.foru.blog.dto.blog.SocialUserInfoDTO;import com.foru.blog.dto.gitee.GiteeTokenDTO;import com.foru.blog.dto.gitee.GiteeUserInfoDTO;import com.foru.blog.dto.github.GitHubUserInfoDTO;import com.foru.blog.enums.LoginTypeEnum;import com.foru.blog.vo.gitee.GiteeLoginVO;import okhttp3.*;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import java.io.IOException;/** * @ClassName GitHubLoginStrategyImpl * @Author 9527 */@Service("githubLoginStrategyImpl")public class GitHubLoginStrategyImpl extends AbstractSocialLoginStrategyImpl{    private GitHubProperties gitHubProperties;    @Autowired    public void setGitHubProperties(GitHubProperties gitHubProperties) {        this.gitHubProperties = gitHubProperties;    }    private Logger logger = LoggerFactory.getLogger(GitHubLoginStrategyImpl.class);    /**     * 获取第三方token信息     *     * @param data 数据     * @return {@link SocialTokenDTO} 第三方token信息     */    @Override    public SocialTokenDTO getSocialToken(String data) {        GiteeLoginVO giteeLoginVO = JSON.parseObject(data, GiteeLoginVO.class);        // 获取微博token信息        GiteeTokenDTO weiboToken = getGitHubToken(giteeLoginVO);        // 返回token信息        return SocialTokenDTO.builder()                //.openId(weiboToken.getUid())                .accessToken(weiboToken.getAccessToken())                .loginType(LoginTypeEnum.GITHUB.getType())                .build();    }    /**     * 获取第三方用户信息     *     * @param socialTokenDTO 第三方token信息     * @return {@link SocialUserInfoDTO} 第三方用户信息     */    @Override    public SocialUserInfoDTO getSocialUserInfo(SocialTokenDTO socialTokenDTO) {        String json = "";        OkHttpClient client = new OkHttpClient();        // 通过该地址能够获取到用户信息        String url = gitHubProperties.getUserInfoUrl() ;        Request request = new Request.Builder()                .addHeader("Content-Type","application/json;charset=UTF-8")                .addHeader("Accept","application/json")                .addHeader("Authorization","token " + socialTokenDTO.getAccessToken())                .get()                .url(url)                .build();        try {            Response response = client.newCall(request).execute();            json = response.body().string();            logger.info("GitHub getSocialUserInfo response data is :{}",json);        } catch (IOException e) {            e.printStackTrace();        }        GitHubUserInfoDTO info = JSON.parseObject(json,GitHubUserInfoDTO.class);        SocialUserInfoDTO dto = SocialUserInfoDTO.builder()                .nickname(info.getName())                .avatar(replaceHttp(info.getAvatar_url()))                .thirdId(info.getId().toString())                .build();        return dto;    }    public GiteeTokenDTO getGitHubToken(GiteeLoginVO giteeLoginVO) {        OkHttpClient client = new OkHttpClient();        // 通过该地址能够获取到access_token        String url = gitHubProperties.getAccessTokenUrl();        // 封装请求参数        RequestBody requestBody = new FormBody.Builder()                .add(SocialLoginConst.CODE, giteeLoginVO.getCode())                .add(SocialLoginConst.CLIENT_ID, gitHubProperties.getAppId())                .add(SocialLoginConst.REDIRECT_URI, gitHubProperties.getRedirectUrl())                .add(SocialLoginConst.CLIENT_SECRET, gitHubProperties.getAppSecret())                .build();        Request request = new Request.Builder()                .addHeader("Content-Type","application/json;charset=UTF-8")                .addHeader("Accept","application/json")                .post(requestBody)                .url(url).build();        String accessKey = "";        try {            Response response = client.newCall(request).execute();            String json = response.body().string();            logger.info("getGitHubToken response data is :{}",json);            // 获取json串中的access_token属性            accessKey = (String) JSONObject.parseObject(json).get(SocialLoginConst.ACCESS_TOKEN);        } catch (IOException e) {            e.printStackTrace();        }        GiteeTokenDTO data = GiteeTokenDTO.builder().accessToken(accessKey)                .appId(gitHubProperties.getAppId())                .appSecret(gitHubProperties.getAppSecret())                .redirectUrl(gitHubProperties.getRedirectUrl())                .code(giteeLoginVO.getCode())                .build();        return data;    }}